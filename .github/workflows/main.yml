name: LinkGeç Deploy & Keep Alive

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '*/15 * * * *'  # Her 15 dakikada bir çalıştır (aktif tut)
  workflow_dispatch:  # Manuel tetikleme

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test app startup
      run: |
        echo "🚀 LinkGeç uygulaması başlatılıyor..."
        timeout 30 python app.py &
        APP_PID=$!
        sleep 10
        
        # Test et
        if curl -f http://localhost:5001 > /dev/null 2>&1; then
          echo "✅ App başarıyla çalışıyor!"
          echo "📱 Ana sayfa: http://localhost:5001"
          echo "🔧 Admin panel: http://localhost:5001/admin"
          echo "👤 Giriş: admin / admin123"
        else
          echo "❌ App başlatılamadı!"
          exit 1
        fi
        
        # Process'i sonlandır
        kill $APP_PID 2>/dev/null || true
        
    - name: Deploy to Render/Railway (Simulation)
      run: |
        echo "🌐 Deployment simülasyonu..."
        echo "📋 Gerçek deployment için:"
        echo "1. Render.com'a git"
        echo "2. Web Service oluştur"
        echo "3. GitHub repo'yu bağla"
        echo "4. Build command: pip install -r requirements.txt"
        echo "5. Start command: python app.py"
        echo "6. Port: 5001"
        echo ""
        echo "🔗 Alternatif platformlar:"
        echo "- Railway.app"
        echo "- Heroku"
        echo "- DigitalOcean App Platform"
        echo "- PythonAnywhere"
        
    - name: Keep Alive Ping
      if: github.event_name == 'schedule'
      run: |
        echo "🏃 Keep-alive ping çalışıyor..."
        echo "⏰ Son çalışma: $(date)"
        echo "🔄 Bir sonraki ping: 15 dakika sonra"
        
        # GitHub Pages'e ping at (eğer varsa)
        if curl -f "https://$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]' | sed 's/\//.github.io\//')" > /dev/null 2>&1; then
          echo "✅ GitHub Pages aktif"
        fi
        
    - name: Create deployment status
      run: |
        echo "📊 Deployment durumu:"
        echo "✅ Kod kontrolü: Başarılı"
        echo "✅ Dependencies: Yüklendi"
        echo "✅ App testi: Geçti"
        echo "⏰ Son güncelleme: $(date)"
        echo ""
        echo "🌍 Canlı deployment için Render.com kullan:"
        echo "https://render.com"
        echo ""
        echo "🔧 Hızlı deployment komutu:"
        echo "git clone $GITHUB_SERVER_URL/$GITHUB_REPOSITORY"
        echo "cd $(basename $GITHUB_REPOSITORY)"
        echo "pip install -r requirements.txt"
        echo "python app.py"
